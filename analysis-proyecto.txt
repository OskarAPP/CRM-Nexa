================================================================================
                    AN√ÅLISIS COMPLETO DEL PROYECTO CRM-NEXA
================================================================================

Fecha de an√°lisis: 2024-12-03
Proyecto: CRM-Nexa - Sistema de gesti√≥n de relaciones con clientes integrado con WhatsApp
Repositorio: OskarAPP/CRM-Nexa

================================================================================
1. SEGURIDAD UTILIZADA EN EL PROYECTO
================================================================================

1.1 MECANISMOS DE AUTENTICACI√ìN
---------------------------------

1.1.1 Laravel Sanctum (Stateful API Authentication)
   - Ubicaci√≥n: backend/config/sanctum.php
   - Implementaci√≥n: Laravel Sanctum v3.3
   - Tipo: Autenticaci√≥n basada en sesiones para SPA (Single Page Application)
   - Guard principal: 'web' (configurado en sanctum.php l√≠nea 36)
   - Middleware: auth:sanctum utilizado en todas las rutas protegidas (backend/routes/api.php l√≠neas 15-37)
   
1.1.2 Sistema de Sesiones
   - Driver: file (backend/config/session.php l√≠nea 21)
   - Lifetime: 120 minutos (backend/config/session.php l√≠nea 34)
   - Cookie de sesi√≥n: encriptada y con HttpOnly habilitado
   - Configuraci√≥n de cookies:
     * http_only: true (l√≠nea 184) - Protecci√≥n contra XSS
     * same_site: 'lax' (l√≠nea 199) - Protecci√≥n parcial contra CSRF
     * secure: configurable via SESSION_SECURE_COOKIE (l√≠nea 171)
   - Regeneraci√≥n de sesi√≥n: Implementada en login/logout (AuthController.php l√≠neas 48, 70, 136)

1.1.3 Cookies de Autenticaci√≥n
   - Cookie XSRF-TOKEN: Utilizada para validaci√≥n CSRF en requests AJAX
   - Frontend obtiene token: Login.tsx l√≠neas 19-23, mensajes.tsx l√≠neas 16-20
   - Cookie de sesi√≥n: Encriptada mediante EncryptCookies middleware

1.1.4 Credenciales de Usuarios
   - Hash de contrase√±as: bcrypt con 10 rounds (backend/config/hashing.php l√≠neas 18, 32)
   - Implementaci√≥n: Hash::make() en AuthController.php l√≠nea 41
   - Validaci√≥n: Auth::attempt() en AuthController.php l√≠nea 64
   - Confirmaci√≥n de password requerida: 'confirmed' en registro (AuthController.php l√≠nea 30)

1.2 M√âTODOS DE AUTORIZACI√ìN
----------------------------

1.2.1 Middleware de Autorizaci√≥n
   - Sanctum authentication middleware: backend/app/Http/Kernel.php l√≠nea 42
   - EnsureFrontendRequestsAreStateful: Garantiza que requests del frontend mantienen estado
   - Middleware 'auth:sanctum': Protege todas las rutas de la API excepto login/register

1.2.2 Verificaci√≥n de Propiedad de Recursos
   - Plantillas: Validaci√≥n user_id (PlantillaController.php l√≠neas 18, 32, 79)
   - Credenciales WhatsApp: Filtrado por user_id (ContactController.php l√≠neas 23, 88)
   - Mensajes: Verificaci√≥n de usuario autenticado antes de env√≠o

1.2.3 Control de Acceso a Rutas
   Frontend (React Router):
   - RequireAuth wrapper: front/src/auth/RequireAuth.tsx
   - RedirectIfAuthenticated: front/src/auth/RedirectIfAuthenticated.tsx
   - Rutas protegidas: /mensajes, /contactos, /home-dashboard

1.3 PROTECCI√ìN CONTRA ATAQUES COMUNES
--------------------------------------

1.3.1 Protecci√≥n CSRF (Cross-Site Request Forgery)
   - Middleware: VerifyCsrfToken habilitado para grupo 'web' (Kernel.php l√≠nea 37)
   - Token XSRF: Enviado en header 'X-XSRF-TOKEN' desde frontend
   - Cookie CSRF: Endpoint /sanctum/csrf-cookie para obtener token
   - Verificaci√≥n: Sanctum valida autom√°ticamente tokens CSRF en requests stateful

1.3.2 Protecci√≥n XSS (Cross-Site Scripting)
   - React: Escape autom√°tico de datos en JSX
   - HttpOnly cookies: Previene acceso JavaScript a cookies de sesi√≥n (session.php l√≠nea 184)
   - Content-Type headers: Forzado a 'application/json' en todas las respuestas API
   - Sanitizaci√≥n en backend: sanitizeEvolutionPayload() remueve campos sensibles (AuthController.php l√≠neas 341-360)

1.3.3 Protecci√≥n SQL Injection
   - Eloquent ORM: Uso exclusivo de prepared statements
   - Validaci√≥n de entrada: Implementada en todos los controllers
   - Ejemplos:
     * $request->validate() en AuthController.php l√≠neas 25-34, 59-62
     * Eloquent where() en lugar de raw queries
     * No se detectaron raw queries sin binding

1.3.4 CORS (Cross-Origin Resource Sharing)
   - Configuraci√≥n: backend/config/cors.php
   - Paths permitidos: ['api/*', 'sanctum/csrf-cookie'] (l√≠nea 18)
   - M√©todos permitidos: Todos ['*'] (l√≠nea 20)
   - Or√≠genes permitidos: Configurables via CORS_ALLOWED_ORIGINS
     * Por defecto: localhost:5173, 127.0.0.1:5173, localhost:8000, 127.0.0.1:8000
   - Credentials: true (l√≠nea 32) - Permite cookies en requests cross-origin
   - Headers permitidos: Todos ['*'] (l√≠nea 26)
   - Middleware: HandleCors en stack global (Kernel.php l√≠nea 19)

1.3.5 Rate Limiting
   - Middleware: ThrottleRequests aplicado al grupo 'api' (Kernel.php l√≠nea 43)
   - Configuraci√≥n: ':api' (usa configuraci√≥n por defecto de Laravel)
   - Ubicaci√≥n: Implementado en nivel de framework

1.3.6 Sanitizaci√≥n de Datos
   - TrimStrings middleware: Limpia espacios en blanco (Kernel.php l√≠nea 22)
   - ConvertEmptyStringsToNull: Normaliza strings vac√≠os (Kernel.php l√≠nea 23)
   - Sanitizaci√≥n de respuestas API: sanitizeEvolutionPayload() elimina apikeys y tokens
     * Campos removidos: apikey, apiKey, api_key, token, session, sessionToken (AuthController.php l√≠neas 345-356)

1.3.7 Validaci√≥n de Entrada
   - Validaci√≥n en registro: nombres, apellidos, email, password, etc. (AuthController.php l√≠neas 25-34)
   - Validaci√≥n en mensajes: numeros, mensaje requeridos (MessageController.php l√≠neas 13-16)
   - Validaci√≥n en plantillas: name, type, payload (PlantillaController.php l√≠neas 47-52)
   - Validaci√≥n de tipos: Rule::in() para valores permitidos

1.4 POL√çTICAS DE SEGURIDAD DEFINIDAS
-------------------------------------

1.4.1 Headers de Seguridad
   - CORS headers: Configurados en cors.php
   - Content-Type: Forzado a application/json en APIs
   - Accept: application/json requerido en requests
   
   NOTA: No se detectaron configuraciones expl√≠citas de:
   - Content-Security-Policy (CSP)
   - X-Frame-Options
   - X-Content-Type-Options
   - Strict-Transport-Security (HSTS)
   - Estas deber√≠an configurarse en producci√≥n

1.4.2 Pol√≠ticas de Sesi√≥n
   - Session lifetime: 120 minutos
   - Session encryption: No habilitada (session.php l√≠nea 49)
   - Session cookie same-site: 'lax'
   - Regeneraci√≥n autom√°tica en login/logout

1.4.3 Pol√≠ticas de Contrase√±a
   - Longitud m√≠nima: 6 caracteres (AuthController.php l√≠nea 30)
   - Confirmaci√≥n requerida: 'confirmed' validation rule
   - Hash: bcrypt con 10 rounds
   
   RECOMENDACI√ìN: Aumentar longitud m√≠nima a 8-12 caracteres

1.4.4 Manejo de Errores
   - Debug mode: Configurable via APP_DEBUG (.env.example l√≠nea 4)
   - Por defecto debug=true en desarrollo (riesgo si se usa en producci√≥n)
   - Handler de excepciones: backend/app/Exceptions/Handler.php

================================================================================
2. TECNOLOG√çAS Y HERRAMIENTAS EMPLEADAS
================================================================================

2.1 FRAMEWORKS Y LIBRER√çAS BACKEND
-----------------------------------

2.1.1 Framework Principal: Laravel 10
   - Versi√≥n: ^10.0 (composer.json l√≠nea 12)
   - PHP requerido: ^8.1 (composer.json l√≠nea 8)
   - Tipo: Framework PHP full-stack
   - Arquitectura: MVC (Model-View-Controller)

2.1.2 Dependencias Backend Principales
   
   Autenticaci√≥n y Seguridad:
   - laravel/sanctum: ^3.3 (autenticaci√≥n API basada en tokens/sesiones)
   - laravel/tinker: ^2.8 (REPL para Laravel)
   
   HTTP y API:
   - guzzlehttp/guzzle: ^7.2 (cliente HTTP para APIs externas)
   - illuminate/http: * (componente HTTP de Laravel)
   
   Base de Datos:
   - doctrine/dbal: ^3.10 (abstracci√≥n de base de datos)
   
   Testing y Desarrollo:
   - fakerphp/faker: ^1.9.1 (generaci√≥n de datos de prueba)
   - phpunit/phpunit: ^10.0 (framework de testing)
   - mockery/mockery: ^1.4.4 (mocking para tests)
   - laravel/pint: ^1.0 (linter de c√≥digo PHP)
   - laravel/sail: ^1.18 (entorno Docker)
   - nunomaduro/collision: ^7.0 (mejor visualizaci√≥n de errores)
   - spatie/laravel-ignition: ^2.0 (p√°gina de errores mejorada)

2.1.3 Herramientas de Build Backend
   - Vite: ^4.0.0 (backend/package.json l√≠nea 10)
   - Laravel Vite Plugin: ^0.7.2 (integraci√≥n Vite con Laravel)
   - Axios: ^1.1.2 (cliente HTTP JavaScript)

2.2 FRAMEWORKS Y LIBRER√çAS FRONTEND
------------------------------------

2.2.1 Framework Principal: React 19
   - Versi√≥n: ^19.1.1 (front/package.json l√≠nea 13)
   - React DOM: ^19.1.1
   - Tipo: Librer√≠a UI basada en componentes

2.2.2 Dependencias Frontend Principales
   
   Routing:
   - react-router-dom: ^7.9.4 (navegaci√≥n SPA)
   
   Componentes UI:
   - react-qr-code: ^2.0.18 (generaci√≥n de c√≥digos QR)
   
   Desarrollo:
   - TypeScript: ~5.8.3 (tipado est√°tico)
   - @types/react: ^19.1.10
   - @types/react-dom: ^19.1.7
   - @types/node: ^24.7.1
   
   Linting:
   - eslint: ^9.33.0
   - @eslint/js: ^9.33.0
   - eslint-plugin-react-hooks: ^5.2.0
   - eslint-plugin-react-refresh: ^0.4.20
   - typescript-eslint: ^8.39.1
   - globals: ^16.3.0

2.2.3 Herramientas de Build Frontend
   - Vite: ^7.1.2 (bundler y dev server)
   - @vitejs/plugin-react: ^5.0.0 (plugin React para Vite)
   - TypeScript Compiler: ~5.8.3

2.3 VERSIONES DETECTADAS
-------------------------

Backend (composer.json):
- PHP: ^8.1
- Laravel Framework: ^10.0
- Laravel Sanctum: ^3.3
- Guzzle: ^7.2
- Doctrine DBAL: ^3.10
- PHPUnit: ^10.0
- Faker: ^1.9.1

Frontend (package.json):
- Node: Compatible con Vite 7.x (requiere Node 18+)
- React: ^19.1.1
- TypeScript: ~5.8.3
- Vite: ^7.1.2
- React Router: ^7.9.4
- ESLint: ^9.33.0

2.4 SERVICIOS Y APIS EXTERNAS
------------------------------

2.4.1 Evolution API (WhatsApp)
   - URL Base: https://nexa-evolution-api.yyfvlz.easypanel.host
   - Configuraci√≥n: backend/config/services.php l√≠nea 34-36
   - Prop√≥sito: Integraci√≥n con WhatsApp Business API
   - Autenticaci√≥n: API Key en header 'apikey'
   - Endpoints utilizados:
     * /instance/connect/{instance}
     * /instance/logout/{instance}
     * /instance/status/{instance}
     * /instance/connectionState/{instance}
     * /chat/findContacts/{instance}
     * /message/sendText/{instance}
     * /message/sendMedia/{instance}

2.4.2 CDN Externos
   - Font Awesome: 6.4.0 (Login.tsx l√≠nea 254, mensajes.tsx l√≠nea 56)
   - URL: https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css

================================================================================
3. ENCRIPTACI√ìN Y MANEJO DE DATOS
================================================================================

3.1 ALGORITMOS DE CIFRADO UTILIZADOS
-------------------------------------

3.1.1 Bcrypt (Contrase√±as)
   - Algoritmo: bcrypt
   - Configuraci√≥n: backend/config/hashing.php l√≠nea 18
   - Rounds: 10 (configurable via BCRYPT_ROUNDS)
   - Implementaci√≥n: Hash::make() facade
   - Uso: Hasheo de contrase√±as de usuario (AuthController.php l√≠nea 41)
   - Caracter√≠sticas:
     * Salt autom√°tico
     * Resistente a ataques de fuerza bruta
     * Incremento adaptativo de complejidad

3.1.2 Encriptaci√≥n de Cookies
   - Middleware: EncryptCookies (Kernel.php l√≠nea 33)
   - Algoritmo: AES-256-CBC (por defecto en Laravel)
   - Clave: APP_KEY en archivo .env
   - Cookies encriptadas:
     * Cookie de sesi√≥n Laravel
     * Cookies personalizadas del framework
   - Excepciones: Cookies que no requieren encriptaci√≥n pueden definirse

3.1.3 Encriptaci√≥n de Sesiones
   - Habilitada: No (session.php l√≠nea 49, encrypt: false)
   - Almacenamiento: Archivos en storage/framework/sessions
   - 
   RECOMENDACI√ìN: Habilitar encriptaci√≥n de sesi√≥n en producci√≥n

3.2 UBICACI√ìN Y USO DE CLAVES, ARCHIVOS .ENV, TOKENS O CREDENCIALES
--------------------------------------------------------------------

3.2.1 Archivo .env (No incluido en repositorio)
   - Ubicaci√≥n esperada: backend/.env
   - Ejemplo: backend/.env.example
   - Variables sensibles esperadas:
     * APP_KEY: Clave de encriptaci√≥n de la aplicaci√≥n
     * DB_PASSWORD: Contrase√±a de base de datos
     * EVOLUTION_BASE_URL: URL de la API de WhatsApp
     * SESSION_SECURE_COOKIE: Configuraci√≥n de cookies seguras
     * CORS_ALLOWED_ORIGINS: Or√≠genes permitidos para CORS
   
   - .gitignore: .env est√° excluido del repositorio ‚úì

3.2.2 Credenciales WhatsApp
   - Modelo: CredencialWhatsapp (backend/app/Models/CredencialWhatsapp.php)
   - Almacenamiento: Base de datos MySQL
   - Campos sensibles:
     * instancia: Nombre de instancia WhatsApp
     * apikey: Clave API para Evolution API
   - Protecci√≥n:
     * No se exponen en respuestas API (makeHidden)
     * Sanitizaci√≥n en sanitizeEvolutionPayload()
     * Filtrado por user_id (un usuario solo ve sus credenciales)

3.2.3 API Keys en Tr√°nsito
   - Evolution API: API key enviada en header 'apikey'
   - Implementaci√≥n: AuthController.php l√≠neas 230-233, MessageController.php l√≠neas 54-57
   - Almacenamiento local: No se almacenan en localStorage/cookies del navegador
   - 
   RIESGO: API keys enviadas en headers HTTP plano (mitigado por HTTPS en producci√≥n)

3.2.4 Tokens de Sesi√≥n
   - Laravel Session Token: Almacenado en cookie encriptada
   - XSRF-TOKEN: Cookie no encriptada (necesaria para lectura desde JavaScript)
   - Regeneraci√≥n: Autom√°tica en login/logout

3.3 M√âTODOS DE HASH, SALTING Y ALMACENAMIENTO SEGURO
-----------------------------------------------------

3.3.1 Hashing de Contrase√±as
   - M√©todo: Hash::make($password)
   - Algoritmo: bcrypt
   - Salt: Generado autom√°ticamente por bcrypt
   - Verificaci√≥n: Hash::check($input, $hashed) o Auth::attempt()
   - Almacenamiento: Campo 'password' en tabla users (tipo string, longitud suficiente para hash)

3.3.2 Tokens CSRF
   - Generaci√≥n: Laravel autom√°ticamente
   - Almacenamiento: Cookie XSRF-TOKEN
   - Validaci√≥n: VerifyCsrfToken middleware
   - Regeneraci√≥n: En cada request

3.3.3 Claves de Encriptaci√≥n
   - APP_KEY: Generada con php artisan key:generate
   - Formato: base64:... (32 bytes aleatorios)
   - Uso: Encriptaci√≥n de cookies y datos sensibles
   - 
   CR√çTICO: APP_KEY debe ser √∫nica por entorno y nunca compartida

3.3.4 Almacenamiento de Datos Sensibles
   - Contrase√±as: Hasheadas con bcrypt, nunca en texto plano
   - API Keys WhatsApp: En base de datos, no expuestas en frontend
   - Tokens de sesi√≥n: En archivos/storage con permisos restrictivos
   - 
   BUENA PR√ÅCTICA: makeHidden(['password']) en modelos User

3.3.5 Limpieza de Datos Sensibles
   - Funci√≥n: sanitizeEvolutionPayload() (AuthController.php l√≠neas 341-360)
   - Elimina: apikey, apiKey, api_key, token, session, sessionToken
   - Uso: Antes de enviar respuestas al frontend
   - Estrategia: Arr::forget() para remover claves anidadas

================================================================================
4. COMUNICACI√ìN Y CONSUMO DE SERVICIOS
================================================================================

4.1 ENDPOINTS EXTERNOS UTILIZADOS
----------------------------------

4.1.1 Evolution API (WhatsApp Business)
   - URL Base: https://nexa-evolution-api.yyfvlz.easypanel.host
   - Protocolo: HTTPS ‚úì
   
   Endpoints implementados:
   
   a) Gesti√≥n de Instancias:
      - GET /instance/connect/{instance}
        * Prop√≥sito: Conectar instancia WhatsApp
        * Respuesta: QR code para vinculaci√≥n
        * Implementaci√≥n: AuthController.php l√≠neas 209-215
      
      - GET /instance/status/{instance}
        * Prop√≥sito: Verificar estado de conexi√≥n
        * Implementaci√≥n: AuthController.php l√≠neas 217-223
      
      - DELETE /instance/logout/{instance}
        * Prop√≥sito: Cerrar sesi√≥n WhatsApp
        * Implementaci√≥n: AuthController.php l√≠neas 113-117
      
      - GET /instance/connectionState/{instance}
        * Prop√≥sito: Polling de estado de conexi√≥n
        * Implementaci√≥n: InstanceController.php
        * Uso frontend: Login.tsx l√≠nea 357
   
   b) Gesti√≥n de Contactos:
      - POST /chat/findContacts/{instance}
        * Prop√≥sito: Buscar contactos WhatsApp
        * Implementaci√≥n: ContactController.php l√≠neas 35-47
      
   c) Env√≠o de Mensajes:
      - POST /message/sendText/{instance}
        * Prop√≥sito: Enviar mensajes de texto
        * Implementaci√≥n: MessageController.php l√≠neas 37-59
        * Payload: number, text, delay, linkPreview
      
      - POST /message/sendMedia/{instance}
        * Prop√≥sito: Enviar archivos multimedia
        * Implementaci√≥n: MessageController.php l√≠neas 115-140
        * Payload: number, mediatype, mimetype, media, fileName, caption

4.1.2 Laravel Sanctum CSRF
   - URL: {API_BASE}/sanctum/csrf-cookie
   - Prop√≥sito: Obtener cookie CSRF para autenticaci√≥n
   - Implementaci√≥n frontend: Login.tsx l√≠nea 11, mensajes.tsx l√≠nea 36

4.1.3 API Interna (Backend Laravel)
   - Base URL: http://localhost:8000 (desarrollo)
   - Configurable: VITE_API_BASE_URL
   
   Endpoints autenticados:
   - POST /api/register - Registro de usuarios
   - POST /api/login - Inicio de sesi√≥n
   - POST /api/logout - Cierre de sesi√≥n
   - GET /api/me - Datos del usuario actual
   - GET /api/login/status - Estado WhatsApp
   - POST /api/send-message - Env√≠o de mensajes
   - POST /api/send-media - Env√≠o de multimedia
   - GET /api/plantillas - Listar plantillas
   - POST /api/plantillas - Crear plantilla
   - PUT /api/plantillas/{id} - Actualizar plantilla
   - DELETE /api/plantillas/{id} - Eliminar plantilla
   - POST /api/find-contacts - Buscar contactos
   - POST /api/filter-contacts - Filtrar contactos

4.2 USO DE HTTPS, CERTIFICADOS O VALIDACIONES TLS
--------------------------------------------------

4.2.1 Evolution API
   - Protocolo: HTTPS ‚úì
   - URL: https://nexa-evolution-api.yyfvlz.easypanel.host
   - Validaci√≥n TLS: Por defecto en Guzzle HTTP client
   - Timeout: 15 segundos (AuthController.php l√≠nea 233)
   
4.2.2 Backend Laravel
   - Desarrollo: HTTP (localhost:8000)
   - Producci√≥n: Debe configurarse HTTPS
   - Cookie segura: SESSION_SECURE_COOKIE=true en producci√≥n
   - 
   RECOMENDACI√ìN: Forzar HTTPS en producci√≥n con:
   - Middleware TrustProxies configurado
   - APP_URL con https://
   - SESSION_SECURE_COOKIE=true

4.2.3 Frontend
   - Desarrollo: HTTP (localhost:5173)
   - Credentials: 'include' en todos los fetch (AuthContext.tsx l√≠nea 22)
   - CORS: Configurado para permitir requests con credenciales

4.2.4 Validaci√≥n de Certificados
   - Guzzle: Valida certificados SSL por defecto
   - Fetch API: Valida certificados SSL del navegador
   - 
   No se detectaron configuraciones que deshabiliten validaci√≥n SSL ‚úì

4.3 APIS P√öBLICAS O PRIVADAS IDENTIFICADAS
-------------------------------------------

4.3.1 APIs Privadas (Requieren Autenticaci√≥n)
   
   Backend Laravel:
   - Todas las rutas bajo middleware auth:sanctum
   - Autenticaci√≥n: Cookie de sesi√≥n Laravel
   - CSRF: Token XSRF requerido
   
   Evolution API:
   - Autenticaci√≥n: API key en header 'apikey'
   - Privada por instancia de usuario
   - Un usuario solo accede a su propia instancia

4.3.2 APIs P√∫blicas
   
   Backend Laravel:
   - POST /api/register - Registro (sin autenticaci√≥n previa)
   - POST /api/login - Login (sin autenticaci√≥n previa)
   - POST /usuarios/register - Registro alternativo
   - POST /usuarios/login - Login alternativo

4.3.3 Flujo de Comunicaci√≥n

   1. Frontend solicita CSRF cookie:
      GET {API_BASE}/sanctum/csrf-cookie
   
   2. Frontend env√≠a credenciales:
      POST {API_BASE}/api/login
      Headers: X-XSRF-TOKEN, Content-Type: application/json
      Credentials: include
   
   3. Backend valida y crea sesi√≥n:
      - Verifica CSRF token
      - Autentica con Auth::attempt()
      - Regenera sesi√≥n
      - Consulta Evolution API para estado WhatsApp
   
   4. Backend responde con datos:
      - Usuario (sin password)
      - Credencial WhatsApp (sin apikey)
      - Estado de conexi√≥n WhatsApp
   
   5. Frontend almacena datos:
      - Usuario en AuthContext
      - Metadata en localStorage
   
   6. Requests subsecuentes:
      - Cookie de sesi√≥n autom√°tica
      - XSRF token en header
      - Credentials: include

================================================================================
5. ARQUITECTURA GENERAL
================================================================================

5.1 ESTRUCTURA DEL PROYECTO
----------------------------

5.1.1 Estructura de Directorios Principal

CRM-Nexa/
‚îú‚îÄ‚îÄ backend/                    # Aplicaci√≥n Laravel (API Backend)
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Console/           # Comandos Artisan
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Exceptions/        # Manejo de excepciones
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Http/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Controllers/  # Controladores API
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Middleware/   # Middleware HTTP
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Kernel.php    # Configuraci√≥n HTTP
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Models/           # Modelos Eloquent
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Providers/        # Service Providers
‚îÇ   ‚îú‚îÄ‚îÄ bootstrap/            # Inicializaci√≥n Laravel
‚îÇ   ‚îú‚îÄ‚îÄ config/               # Archivos de configuraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrations/       # Migraciones de BD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ seeders/          # Seeders de datos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ factories/        # Factories para testing
‚îÇ   ‚îú‚îÄ‚îÄ public/               # Punto de entrada web
‚îÇ   ‚îú‚îÄ‚îÄ resources/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ js/              # Assets JavaScript
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ views/           # Vistas Blade (m√≠nimo uso)
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.php          # Rutas de API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ web.php          # Rutas web
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ channels.php     # Broadcasting
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ console.php      # Comandos consola
‚îÇ   ‚îú‚îÄ‚îÄ storage/             # Archivos generados
‚îÇ   ‚îú‚îÄ‚îÄ tests/               # Tests PHPUnit
‚îÇ   ‚îú‚îÄ‚îÄ .env.example         # Template de configuraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ composer.json        # Dependencias PHP
‚îÇ   ‚îî‚îÄ‚îÄ artisan              # CLI de Laravel
‚îÇ
‚îú‚îÄ‚îÄ front/                     # Aplicaci√≥n React (Frontend SPA)
‚îÇ   ‚îú‚îÄ‚îÄ public/               # Assets est√°ticos
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/            # Contexto y guards de autenticaci√≥n
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthContext.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RequireAuth.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RedirectIfAuthenticated.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contacts/        # M√≥dulo de contactos
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Contacts.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ modules/     # Subm√≥dulos de contactos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Inicio/          # Dashboard principal
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ HomeDashboard.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/           # M√≥dulo de login
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Login.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login.css
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mensajes/        # M√≥dulo de mensajer√≠a
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mensajes.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mensajes.css
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templateHistory.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templateHistory.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ templateTypes.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App.tsx          # Componente ra√≠z y rutas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tsx         # Punto de entrada
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vite-env.d.ts    # Tipos Vite
‚îÇ   ‚îú‚îÄ‚îÄ index.html           # HTML principal
‚îÇ   ‚îú‚îÄ‚îÄ package.json         # Dependencias Node
‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json        # Configuraci√≥n TypeScript
‚îÇ   ‚îú‚îÄ‚îÄ vite.config.ts       # Configuraci√≥n Vite
‚îÇ   ‚îî‚îÄ‚îÄ eslint.config.js     # Configuraci√≥n ESLint
‚îÇ
‚îî‚îÄ‚îÄ (archivos ra√≠z)

5.1.2 Separaci√≥n Frontend/Backend
   - Backend: API RESTful stateless (excepto sesiones)
   - Frontend: SPA React independiente
   - Comunicaci√≥n: JSON sobre HTTP/HTTPS
   - Desarrollo: Dos servidores separados (Vite:5173, Laravel:8000)
   - Producci√≥n: Frontend servido como assets est√°ticos, API en subdominio/path

5.2 PATRONES DETECTADOS
------------------------

5.2.1 Patr√≥n MVC (Model-View-Controller) - Backend
   
   Models (app/Models/):
   - User.php: Modelo de usuarios
   - CredencialWhatsapp.php: Credenciales WhatsApp
   - Plantilla.php: Plantillas de mensajes
   - Usuario.php: Modelo alternativo de usuario
   
   Controllers (app/Http/Controllers/):
   - AuthController.php: Autenticaci√≥n y sesiones
   - ContactController.php: Gesti√≥n de contactos WhatsApp
   - MessageController.php: Env√≠o de mensajes
   - PlantillaController.php: CRUD de plantillas
   - CredencialWhatsappController.php: Gesti√≥n de credenciales
   - InstanceController.php: Estado de instancias WhatsApp
   - UsuarioController.php: Gesti√≥n alternativa de usuarios
   
   Views:
   - M√≠nimas (Laravel usado principalmente como API)
   - resources/views/welcome.blade.php

5.2.2 Patr√≥n Repository (Impl√≠cito con Eloquent)
   - Eloquent ORM act√∫a como repository pattern
   - Ejemplos:
     * CredencialWhatsapp::where('user_id', $user->id)->first()
     * Plantilla::create(...), Plantilla::find($id)
   - Abstracci√≥n de acceso a datos

5.2.3 Patr√≥n Service Layer (Parcial)
   - performEvolutionRequest(): Abstrae comunicaci√≥n con Evolution API
   - buildWhatsappPayload(): Normaliza respuestas de API
   - sanitizeEvolutionPayload(): Limpia datos sensibles
   - Implementados como m√©todos protegidos en AuthController

5.2.4 Patr√≥n Middleware (Chain of Responsibility)
   - Stack de middleware global (Kernel.php l√≠neas 16-24)
   - Middleware groups (web, api)
   - Middleware aliases
   - Ejecuci√≥n secuencial antes/despu√©s de request

5.2.5 Context Pattern - Frontend
   - AuthContext.tsx: Gesti√≥n global de autenticaci√≥n
   - Proveedor: AuthProvider
   - Hook: useAuthContext()
   - Estado compartido: status, user, refresh, markAuthenticated, markLoggedOut

5.2.6 Higher-Order Components / Render Props
   - RequireAuth: Protege rutas autenticadas
   - RedirectIfAuthenticated: Redirige usuarios ya autenticados
   - Implementaci√≥n: Wrapper components con l√≥gica de autorizaci√≥n

5.2.7 Custom Hooks Pattern
   - useTemplateManager: Gesti√≥n de plantillas (templateHistory.tsx)
   - useCampaignHistory: Historial de campa√±as
   - useAuthContext: Acceso a contexto de autenticaci√≥n

5.2.8 Component-Based Architecture
   - Componentes modulares por funcionalidad:
     * Login.tsx
     * Contacts.tsx
     * Mensajes.tsx
     * HomeDashboard.tsx
   - Subm√≥dulos en carpetas:
     * contacts/modules/: GruposModule, ContactosModule, TodosModule

5.3 FLUJO GENERAL DE DATOS
---------------------------

5.3.1 Flujo de Autenticaci√≥n

   1. Carga inicial:
      - Frontend: AuthProvider monta
      - Llama refresh() (AuthContext.tsx l√≠nea 63)
      - Intenta GET /api/me
      - Si falla: status='unauthenticated'
      - Si exitoso: status='authenticated', almacena user
   
   2. Login usuario:
      - Usuario ingresa email/password en Login.tsx
      - Frontend: ensureCsrfCookie() (l√≠nea 429)
      - Frontend: POST /api/login con credenciales
      - Backend: AuthController::login()
        * Valida credenciales con Auth::attempt()
        * Regenera sesi√≥n
        * Consulta CredencialWhatsapp del usuario
        * Llama Evolution API (connect + status)
        * Sanitiza respuesta
        * Retorna usuario + credencial + whatsapp_session
      - Frontend: markAuthenticated(user)
      - Frontend: Guarda metadata en localStorage
      - Frontend: Muestra QR si WhatsApp no conectado
   
   3. Vinculaci√≥n WhatsApp:
      - Usuario escanea QR
      - Frontend: Polling cada 5s a /api/instance/connectionState
      - Backend: Consulta Evolution API
      - Cuando state='CONNECTED': redirect a /home-dashboard
   
   4. Requests subsecuentes:
      - Frontend: Cookie de sesi√≥n enviada autom√°ticamente
      - Frontend: XSRF token en header
      - Backend: Middleware auth:sanctum valida sesi√≥n
      - Backend: $request->user() obtiene usuario autenticado

5.3.2 Flujo de Env√≠o de Mensajes

   1. Usuario en /mensajes:
      - Ingresa n√∫meros y mensaje
      - Selecciona plantilla (opcional)
      - Click "Enviar"
   
   2. Frontend prepara request:
      - ensureCsrfCookie()
      - POST /api/send-message
      - Body: { numeros: [...], mensaje: "..." }
      - Headers: X-XSRF-TOKEN, Content-Type, Accept
      - Credentials: include
   
   3. Backend procesa:
      - MessageController::sendMessage()
      - Valida entrada (numeros, mensaje)
      - Obtiene $user = $request->user()
      - Consulta CredencialWhatsapp
      - Por cada n√∫mero:
        * Guzzle POST a Evolution API /message/sendText/{instance}
        * Header apikey: {credencial->apikey}
        * Body: { number, text, delay, linkPreview }
        * Captura respuesta o error
      - Retorna array de resultados
   
   4. Frontend muestra resultados:
      - Lista de mensajes enviados
      - Estado por n√∫mero (SUCCESS/ERROR)
      - Mensaje de confirmaci√≥n

5.3.3 Flujo de Gesti√≥n de Contactos

   1. Frontend: POST /api/find-contacts o /api/filter-contacts
   2. Backend: ContactController
      - Obtiene credencial del usuario
      - Guzzle POST a Evolution API /chat/findContacts/{instance}
      - Opcionalmente filtra por country_code, area_codes
      - Retorna lista de contactos
   3. Frontend: Muestra contactos en m√≥dulos (Todos, Grupos, Contactos)

5.3.4 Flujo de Gesti√≥n de Plantillas

   1. Listar: GET /api/plantillas
      - PlantillaController::index()
      - Plantilla::where('user_id', $usuario->id)->get()
      - Retorna plantillas del usuario
   
   2. Crear: POST /api/plantillas
      - Validaci√≥n: name, type, payload
      - validatePayload() seg√∫n tipo (texto/media)
      - Plantilla::create() con UUID
      - Retorna plantilla creada
   
   3. Actualizar: PUT /api/plantillas/{id}
      - Verifica ownership (user_id)
      - Valida cambios
      - update() en modelo
   
   4. Eliminar: DELETE /api/plantillas/{id}
      - Verifica ownership
      - delete() en modelo

5.3.5 Diagrama de Capas

   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ           Frontend (React SPA)              ‚îÇ
   ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
   ‚îÇ  ‚îÇ  UI Components (tsx)                ‚îÇ   ‚îÇ
   ‚îÇ  ‚îÇ  - Login, Mensajes, Contacts, etc.  ‚îÇ   ‚îÇ
   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
   ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
   ‚îÇ  ‚îÇ  Contexts & Hooks                   ‚îÇ   ‚îÇ
   ‚îÇ  ‚îÇ  - AuthContext, useTemplateManager  ‚îÇ   ‚îÇ
   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
   ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
   ‚îÇ  ‚îÇ  API Client (fetch)                 ‚îÇ   ‚îÇ
   ‚îÇ  ‚îÇ  - Credentials, XSRF tokens         ‚îÇ   ‚îÇ
   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ HTTPS/JSON
                      ‚Üì
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ         Backend (Laravel API)               ‚îÇ
   ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
   ‚îÇ  ‚îÇ  HTTP Middleware Stack              ‚îÇ   ‚îÇ
   ‚îÇ  ‚îÇ  - CORS, Auth, CSRF, Throttle       ‚îÇ   ‚îÇ
   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
   ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
   ‚îÇ  ‚îÇ  Controllers                        ‚îÇ   ‚îÇ
   ‚îÇ  ‚îÇ  - Auth, Message, Plantilla, etc.   ‚îÇ   ‚îÇ
   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
   ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
   ‚îÇ  ‚îÇ  Models (Eloquent ORM)              ‚îÇ   ‚îÇ
   ‚îÇ  ‚îÇ  - User, Plantilla, Credencial      ‚îÇ   ‚îÇ
   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
   ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
   ‚îÇ  ‚îÇ  External API Client (Guzzle)       ‚îÇ   ‚îÇ
   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ MySQL                    ‚îÇ HTTPS
          ‚Üì                          ‚Üì
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ   Database   ‚îÇ      ‚îÇ   Evolution API     ‚îÇ
   ‚îÇ   (MySQL)    ‚îÇ      ‚îÇ   (WhatsApp)        ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

================================================================================
6. POSIBLES RIESGOS O MALAS PR√ÅCTICAS
================================================================================

6.1 DEPENDENCIAS OBSOLETAS O VULNERABLES
-----------------------------------------

6.1.1 Estado de Dependencias Backend
   
   Laravel Framework:
   - Laravel 10: Lanzado en 2023, soporte hasta Feb 2024 (bug fixes)
   - Estado: Versi√≥n estable pero no la m√°s reciente (Laravel 11 disponible)
   - RECOMENDACI√ìN: Considerar migraci√≥n a Laravel 11 para soporte extendido
   
   PHP:
   - Requerido: ^8.1
   - PHP 8.1: Soporte de seguridad hasta Nov 2025
   - RECOMENDACI√ìN: Migrar a PHP 8.2 o 8.3 para soporte extendido
   
   Otras dependencias:
   - Sanctum 3.3: Actualizada ‚úì
   - Guzzle 7.2: Versi√≥n estable ‚úì
   - PHPUnit 10: Versi√≥n actual ‚úì
   
   ACCI√ìN REQUERIDA:
   - Ejecutar: composer audit
   - Verificar CVEs en packagist.org
   - Actualizar packages con vulnerabilidades conocidas

6.1.2 Estado de Dependencias Frontend
   
   React:
   - Versi√≥n 19.1.1: Muy reciente (React 19 liberado en Dic 2024)
   - Estado: Potencialmente inestable por ser nueva major version
   - ATENCI√ìN: Verificar compatibilidad con librer√≠as existentes
   
   Vite:
   - Versi√≥n 7.1.2: Actualizado ‚úì
   
   React Router:
   - Versi√≥n 7.9.4: Actualizado ‚úì
   
   TypeScript:
   - Versi√≥n 5.8.3: Actualizado ‚úì
   
   ACCI√ìN REQUERIDA:
   - Ejecutar: npm audit
   - Revisar issues de React 19 con librer√≠as de terceros
   - Verificar breaking changes en ecosistema React

6.2 ARCHIVOS INSEGUROS O CLAVES EXPUESTAS
------------------------------------------

6.2.1 Claves en C√≥digo Fuente

   CR√çTICO - URL de Evolution API hardcoded:
   - Ubicaciones:
     * AuthController.php l√≠nea 19
     * MessageController.php l√≠neas 37, 115
     * ContactController.php l√≠neas 35, 100
   - Valor: https://nexa-evolution-api.yyfvlz.easypanel.host
   - Problema: URL hardcoded en c√≥digo, no configurable por entorno
   - Estado: Mitigado parcialmente en config/services.php pero no usado consistentemente
   - SOLUCI√ìN: Usar config('services.evolution.base_url') en todos los controllers

   API Keys WhatsApp:
   - Estado: No expuestas en c√≥digo ‚úì
   - Almacenadas: Base de datos
   - Protegidas: makeHidden(), sanitizeEvolutionPayload()
   - Riesgo: Medio (depende de seguridad de BD)

6.2.2 Archivos Sensibles en Repositorio
   
   .env:
   - Estado: Correctamente excluido en .gitignore ‚úì
   
   .env.example:
   - Estado: Presente (esperado) ‚úì
   - Contenido: Valores de ejemplo sin credenciales reales ‚úì
   
   Logs:
   - Estado: storage/ excluido en .gitignore ‚úì
   
   Sesiones:
   - Estado: storage/framework/sessions en .gitignore ‚úì

6.2.3 Informaci√≥n en localStorage
   - Datos almacenados:
     * user_id
     * instance
     * nombres
   - Riesgo: Bajo (informaci√≥n no cr√≠tica)
   - Vulnerabilidad: XSS podr√≠a leer localStorage
   - Mitigaci√≥n: HttpOnly cookies para tokens sensibles ‚úì

6.3 CONFIGURACIONES RIESGOSAS
------------------------------

6.3.1 Debug Mode en Producci√≥n
   - Configuraci√≥n: APP_DEBUG en .env
   - .env.example: APP_DEBUG=true (desarrollo)
   - RIESGO CR√çTICO: Si APP_DEBUG=true en producci√≥n:
     * Exposici√≥n de stack traces
     * Revelaci√≥n de rutas de archivos
     * Informaci√≥n de configuraci√≥n sensible
   - SOLUCI√ìN: APP_DEBUG=false en producci√≥n

6.3.2 CORS Permisivo
   - allowed_methods: ['*'] (cors.php l√≠nea 20)
   - allowed_headers: ['*'] (cors.php l√≠nea 26)
   - RIESGO: Medio
   - Mitigaci√≥n: allowed_origins limitado a lista espec√≠fica ‚úì
   - RECOMENDACI√ìN: Limitar m√©todos a ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']

6.3.3 Session Encryption Deshabilitada
   - Configuraci√≥n: 'encrypt' => false (session.php l√≠nea 49)
   - RIESGO: Datos de sesi√≥n en texto plano en storage
   - RECOMENDACI√ìN: 'encrypt' => true en producci√≥n

6.3.4 Cookies sin Secure Flag
   - SESSION_SECURE_COOKIE: No definido en .env.example
   - Por defecto: null (inseguro en producci√≥n)
   - RIESGO: Cookies enviadas sobre HTTP
   - SOLUCI√ìN: SESSION_SECURE_COOKIE=true en producci√≥n con HTTPS

6.3.5 Falta de Headers de Seguridad
   - Content-Security-Policy: No configurado
   - X-Frame-Options: No configurado expl√≠citamente
   - X-Content-Type-Options: No configurado
   - Strict-Transport-Security: No configurado
   - RECOMENDACI√ìN: Agregar middleware para headers de seguridad

6.3.6 Rate Limiting Gen√©rico
   - Configuraci√≥n: ':api' (usa defaults de Laravel)
   - L√≠mite por defecto: 60 requests/minuto
   - RIESGO: Posible abuso en endpoints cr√≠ticos (login, env√≠o masivo)
   - RECOMENDACI√ìN: Rate limiting espec√≠fico para:
     * Login: 5 intentos/minuto
     * Registro: 3 intentos/minuto
     * Env√≠o mensajes: seg√∫n plan del usuario

6.4 VALIDACIONES INSUFICIENTES
-------------------------------

6.4.1 Validaci√≥n de Contrase√±as
   - Longitud m√≠nima: 6 caracteres (AuthController.php l√≠nea 30)
   - RIESGO: Contrase√±as d√©biles
   - Falta:
     * Validaci√≥n de complejidad
     * Verificaci√≥n contra diccionarios comunes
     * Historial de contrase√±as
   - RECOMENDACI√ìN: M√≠nimo 8 caracteres, reglas de complejidad

6.4.2 Validaci√≥n de N√∫meros de Tel√©fono
   - MessageController: No valida formato de n√∫meros
   - RIESGO: Env√≠o a n√∫meros inv√°lidos, costos innecesarios
   - RECOMENDACI√ìN: Validaci√≥n de formato internacional

6.4.3 Validaci√≥n de Tama√±o de Archivos
   - sendMedia: No valida tama√±o de media base64
   - RIESGO: DoS con archivos enormes
   - RECOMENDACI√ìN: L√≠mite de tama√±o de payload

6.4.4 Sanitizaci√≥n de Input
   - TrimStrings middleware: B√°sico ‚úì
   - FALTA:
     * Validaci√≥n de HTML en campos de texto
     * Sanitizaci√≥n de nombres de archivo
     * Validaci√≥n de URLs en media

6.5 GESTI√ìN DE ERRORES Y LOGGING
---------------------------------

6.5.1 Exposici√≥n de Errores
   - Debug mode: Expone stack traces completos
   - Mensajes de error: Algunos revelan estructura interna
   - RECOMENDACI√ìN: Mensajes gen√©ricos en producci√≥n

6.5.2 Logging de Informaci√≥n Sensible
   - No se detect√≥ logging expl√≠cito de passwords ‚úì
   - RIESGO: Logs podr√≠an contener API keys en requests
   - RECOMENDACI√ìN: Revisar configuraci√≥n de logging, redactar datos sensibles

6.5.3 Manejo de Excepciones
   - Try-catch gen√©rico: Captura \Exception (muy amplio)
   - RECOMENDACI√ìN: Excepciones espec√≠ficas, logging estructurado

6.6 SEGURIDAD DE THIRD-PARTY APIs
----------------------------------

6.6.1 Evolution API
   - Autenticaci√≥n: Solo API key (sin rotaci√≥n aparente)
   - RIESGO: API key comprometida = acceso total
   - RECOMENDACI√ìN:
     * Rotaci√≥n peri√≥dica de API keys
     * Monitoreo de uso de API
     * Rate limiting en cliente

6.6.2 Validaci√≥n de Respuestas
   - Validaci√≥n m√≠nima de respuestas de Evolution API
   - RIESGO: Respuestas malformadas podr√≠an causar errores
   - RECOMENDACI√ìN: Validaci√≥n estricta de estructura de respuesta

6.7 ARQUITECTURA Y DISE√ëO
--------------------------

6.7.1 Separaci√≥n de Concerns
   - AuthController: Demasiadas responsabilidades (482 l√≠neas)
     * Autenticaci√≥n
     * Integraci√≥n WhatsApp
     * Sanitizaci√≥n
   - RECOMENDACI√ìN: Extraer servicio para Evolution API

6.7.2 C√≥digo Duplicado
   - URL de Evolution API repetida en m√∫ltiples controllers
   - L√≥gica de obtenci√≥n de credenciales duplicada
   - RECOMENDACI√ìN: Service class compartido

6.7.3 Testing
   - No se detectan tests implementados en backend/tests
   - No se detecta configuraci√≥n de tests en frontend
   - RIESGO: Cambios sin validaci√≥n automatizada
   - RECOMENDACI√ìN: Implementar test suite (unitarios, integraci√≥n)

6.8 RESUMEN DE RIESGOS PRIORIZADOS
-----------------------------------

üî¥ CR√çTICOS (Acci√≥n Inmediata):
1. APP_DEBUG=true en producci√≥n ‚Üí Exposici√≥n de informaci√≥n sensible
2. URLs hardcoded en c√≥digo ‚Üí Dificultad de configuraci√≥n por entorno
3. SESSION_SECURE_COOKIE no configurado ‚Üí Cookies inseguras en producci√≥n
4. Falta de headers de seguridad ‚Üí Vulnerabilidades XSS/Clickjacking

üü† ALTOS (Acci√≥n Pronta):
5. Session encryption deshabilitada ‚Üí Datos de sesi√≥n legibles
6. Contrase√±as d√©biles permitidas (6 chars) ‚Üí Fuerza bruta facilitada
7. Falta de rate limiting espec√≠fico ‚Üí Abuso de endpoints
8. CORS permisivo (m√©todos/headers *) ‚Üí Potencial abuso

üü° MEDIOS (Planificar):
9. Laravel 10 sin soporte extendido ‚Üí Falta de parches de seguridad futuros
10. React 19 muy nuevo ‚Üí Posibles bugs no descubiertos
11. Falta de validaci√≥n de tama√±o de archivos ‚Üí DoS
12. Falta de tests automatizados ‚Üí Regresiones no detectadas

üü¢ BAJOS (Mejora Continua):
13. C√≥digo duplicado ‚Üí Mantenibilidad
14. AuthController muy grande ‚Üí Complejidad
15. Informaci√≥n en localStorage ‚Üí XSS leve
16. Validaci√≥n de n√∫meros de tel√©fono ‚Üí UX

================================================================================
                           FIN DEL AN√ÅLISIS
================================================================================

Este an√°lisis ha sido generado mediante revisi√≥n exhaustiva del c√≥digo fuente,
configuraciones, dependencias y arquitectura del proyecto CRM-Nexa.

Todas las observaciones est√°n basadas en el estado actual del c√≥digo en el
repositorio y las mejores pr√°cticas de seguridad de la industria.

Se recomienda:
1. Revisar y abordar los riesgos cr√≠ticos antes de deployment en producci√≥n
2. Implementar un proceso de auditor√≠a de seguridad continua
3. Mantener dependencias actualizadas con composer update / npm update
4. Implementar suite de tests automatizados
5. Configurar CI/CD con verificaciones de seguridad autom√°ticas

Para m√°s informaci√≥n sobre las recomendaciones espec√≠ficas, consultar
documentaci√≥n de Laravel Security, OWASP Top 10, y React Security Best Practices.
