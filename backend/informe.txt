Informe de Seguridad CRM Nexa
============================

Fecha: 2025-11-12

1. Resumen ejecutivo
--------------------
- Se migró el flujo de autenticación a sesiones Sanctum con cookies, reforzando el control de acceso y eliminando el uso directo de `user_id` en las API.
- Las credenciales de WhatsApp ahora se almacenan cifradas y se ocultan en las respuestas JSON, reduciendo el riesgo de fuga.
- El CORS se restringió a orígenes declarados en variables de entorno y las llamadas del frontend se realizan con `credentials: 'include'` y cabeceras CSRF.
- Persiste un error 419 relacionado con dominio/cookie en el entorno local que impide validar end-to-end el nuevo flujo; la corrección requiere completar el alistamiento de dominios y reiniciar servicios.

2. Cambios implementados desde el último informe
-----------------------------------------------
- Reescritura completa de `AuthController` para sesiones Sanctum (`register`, `login`, `logout`, `me`, `whatsappStatus`) y eliminación del consumo de `user_id` en peticiones públicas.
- Agrupación de rutas críticas bajo `Route::middleware('auth:sanctum')` en `routes/api.php` (contactos, mensajería, credenciales de WhatsApp, plantillas).
- Encriptación transparente de `instancia` y `apikey` en `app/Models/CredencialWhatsapp.php`, junto con ocultamiento (`$hidden`) y anti-casteo.
- Formularios HTML (`registro.html`, `registrowp.html`) y clientes React actualizados para negociar la cookie CSRF (`/sanctum/csrf-cookie`), enviar encabezado `X-XSRF-TOKEN` y trabajar con sesiones.
- Configuración CORS parametrizada (`config/cors.php`) con orígenes definidos en `.env`, habilitando únicamente los hosts necesarios y `supports_credentials`.
- Ajuste de `.env` para `APP_URL`, `SESSION_DOMAIN`, `SANCTUM_STATEFUL_DOMAINS`, `CORS_ALLOWED_ORIGINS` y claves relacionadas con Evolution API.
- Sustitución de la URL base por defecto del frontend (`front/src/**`) a `http://localhost:8000` para alinear el dominio con la cookie Sanctum.

3. Medidas de seguridad actualmente vigentes
--------------------------------------------
- Contraseñas hash con `Hash::make` y validaciones exhaustivas en controladores.
- Credenciales externas cifradas en base de datos e inaccesibles en serialización estándar.
- Endpoints sensibles expuestos únicamente tras autenticación Sanctum y sesión activa.
- Peticiones del frontend con inclusión de cookies, CSRF negociado y rechazo de llamadas sin sesión válida.
- Variables de entorno segregadas para dominios, claves y URLs externas; sin valores sensibles hardcodeados en código fuente.

4. Riesgos residuales y tareas pendientes
----------------------------------------
- Error 419 por desalineación de dominios/cookies en entorno local hasta completar la limpieza de cachés y reinicio de servidores (`php artisan serve`, Vite).
- Falta de HTTPS en desarrollo/despliegue, lo que impide marcar cookies como `Secure` y SameSite apropiado.
- Ausencia de controles por rol, MFA, rate limiting específico y auditoría fina.
- Formularios estáticos aún accesibles fuera de Laravel (riesgo mitigado pero no eliminado hasta moverlos a vistas Blade).
- Dependencia de librerías CDN sin SRI; susceptible a ataques de cadena de suministro en producción.

5. Próximas acciones prioritarias
---------------------------------
1. Alinear dominios (frontend/backend) y reiniciar servicios tras `php artisan config:clear` y `php artisan cache:clear` para resolver el 419 y validar el flujo completo.
2. Activar HTTPS en los entornos objetivo, configurando cookies Sanctum con `secure`, `same_site=lax` y cabeceras HSTS.
3. Implementar rate limiting (`RateLimiter::for`) para login y endpoints de mensajería, más bloqueo temporal tras intentos fallidos.
4. Migrar formularios a vistas protegidas por Laravel (Blade + middleware `web`) y retirar accesos directos `file://`.
5. Definir y aplicar políticas/roles (p. ej. admin vs operador) para operaciones críticas sobre credenciales y campañas.

6. Sugerencias complementarias
------------------------------
- Incorporar verificación y recuperación de cuenta (correo/SMS) y endurecer requisitos de contraseña.
- Registrar eventos sensibles (altas, envíos) en un sistema de logging centralizado con alertas.
- Ejecutar revisiones periódicas de dependencias (`composer audit`, `npm audit`) y aplicar parches.
- Establecer rotación y revocación documentada de API keys externas.
- Evaluar pruebas de penetración alineadas con OWASP API Security Top 10 tras cerrar los pendientes anteriores.

Con estas mejoras implementadas y las tareas pendientes identificadas, la plataforma avanza hacia un modelo de seguridad integral basado en sesiones Sanctum, cifrado de secretos y control estricto de orígenes.
